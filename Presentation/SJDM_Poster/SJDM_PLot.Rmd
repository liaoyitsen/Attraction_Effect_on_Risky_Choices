---
title: "2025_SJDM_Poster"
output: pdf_document
date: "2025-10-15"
---

```{r setup, include = FALSE}
library(magrittr)
library(ggplot2)
library(ggpubr)
library(dplyr)
library(modelsummary)
library(estimatr)
library(lme4)
library(patchwork)

knitr::opts_chunk$set(fig.width = 11, fig.height = 7)
knitr::opts_chunk$set(warning = FALSE)

study1 <- readRDS(here::here("data/study1.Rds"))
study1_complete <- readRDS(here::here("data/study1_complete.Rds"))
study1_change <- readRDS(here::here("data/study1_change.Rds"))
pilot1 <- readRDS(here::here("data/study1_change.Rds"))


```







## Cluster SE - No and Opposite Preference Reversal (Treatment)
```{r}
library(dplyr)
library(ggplot2)
library(clubSandwich)
library(broom)

# Compute participant-level means
clustered_estimates <- study1_complete %>%
  filter(treatment == "treatment") %>%
  mutate(
    choose_risky = ifelse(raw_choice == "risky", 1, 0),
    choose_safe  = ifelse(raw_choice == "safe", 1, 0),
    choose_decoy  = ifelse(raw_choice == "decoy", 1, 0)
  ) %>%
  group_by(condition, PROLIFIC_PID) %>%
  summarise(
    risky_rate = mean(choose_risky),
    safe_rate = mean(choose_safe),
    decoy_rate = mean(choose_decoy),
    .groups = "drop"
  )

# Ensure condition is a factor with reference = "risk_averse"
clustered_estimates <- clustered_estimates %>%
  mutate(condition = factor(condition, levels = c("risk_averse", "risk_seeking")))

# Fit linear models
mod_risky <- lm(risky_rate ~ condition, data = clustered_estimates)
mod_safe  <- lm(safe_rate  ~ condition, data = clustered_estimates)
mod_decoy  <- lm(decoy_rate  ~ condition, data = clustered_estimates)

# Clustered SEs
risky_cl <- coef_test(mod_risky, vcov = "CR2", cluster = clustered_estimates$PROLIFIC_PID)
safe_cl  <- coef_test(mod_safe,  vcov = "CR2", cluster = clustered_estimates$PROLIFIC_PID)
decoy_cl  <- coef_test(mod_decoy,  vcov = "CR2", cluster = clustered_estimates$PROLIFIC_PID)

# Inspect result tables
print(risky_cl)
print(safe_cl)
print(decoy_cl)

# Helper function to safely extract coefficient and SE
get_coef_info <- function(tbl) {
  tbl %>%
    dplyr::filter(Coef != "(Intercept)") %>%
    dplyr::summarise(
      diff = beta,
      se   = SE
    ) %>%
    as.list()
}

# Extract risky and safe info
risky_info <- get_coef_info(risky_cl)
safe_info  <- get_coef_info(safe_cl)
decoy_info  <- get_coef_info(decoy_cl)

# Combine into preference reversal table
pref_rev <- tibble(
  lottery = c("Risky lottery", "Safe lottery","Decoy"),
  diff = c(risky_info$diff, -safe_info$diff, decoy_info$diff),  # flip sign for safe
  se = c(risky_info$se, safe_info$se, decoy_info$se)
) %>%
  mutate(
    ci_low = diff - 1.96 * se,
    ci_high = diff + 1.96 * se
  )

# Enhanced visualization for poster
p_treatment_comparison <- ggplot(pref_rev, aes(x = lottery, y = diff, color = lottery)) +
  # Zero line
  geom_hline(yintercept = 0, linetype = "dotted", color = "gray60", linewidth = 0.8) +
  
  # Error bars
  geom_errorbar(aes(ymin = ci_low, ymax = ci_high),
                width = 0.15, linewidth = 1.1) +
  
  # Points
  geom_point(size = 5, show.legend = FALSE) +
  
  # Add numeric labels with custom vjust by lottery
  geom_text(aes(
      label = sprintf("%.3f", diff),
      color = lottery,
      vjust = case_when(
        lottery == "Decoy" ~ -3.5,      # bring decoy text closer
        TRUE ~ -7                     # default for others
      )
    ),
    size = 6, fontface = "bold", show.legend = F) +
  
  # Custom color palette (consistent with prior plots)
  scale_color_manual(values = c(
    "Risky lottery" = "#ff7f0e",  # orange
    "Safe lottery"  = "#1f77b4",  # blue
    "Decoy"         = "black"     # neutral gray
  )) +
  
  # Shrink horizontal spacing
  scale_x_discrete(expand = expansion(mult = c(0.05, 0.05))) +
  
  # Coordinate settings (no clipping)
  coord_cartesian(ylim = c(-0.13, 0.13), expand = FALSE, clip = "off") +
  
  # Labels
  labs(
    x = "",
    y = expression(Delta*" P(Chosen | Focal)"),
    title = "Treatment Risky Decoy vs. Treatment Safe Decoy",
    subtitle = "95% CI clustered by participant"
  ) +
  
  # Theme tuning
  theme_minimal(base_size = 20) +
  theme(
    panel.grid.minor = element_blank(),
    panel.grid.major.x = element_blank(),
    axis.text.x = element_text(size = 16, face = "bold"),
    axis.text.y = element_text(size = 14),
    plot.title = element_text(face = "bold", size = 22, hjust = 0.5),
    plot.subtitle = element_text(size = 14, hjust = 0.5, color = "gray40"),
    axis.title.y = element_text(size = 16, margin = margin(r = 15)),
    plot.margin = margin(10, 20, 25, 10)
  )

p_treatment_comparison
```
## Cluster SE - No Preference Reversal (Control)
```{r}
library(dplyr)
library(ggplot2)
library(clubSandwich)
library(broom)

# Compute participant-level means
clustered_estimates1 <- study1_complete %>%
  filter(treatment == "control") %>%
  mutate(
    choose_risky = ifelse(raw_choice == "risky", 1, 0),
    choose_safe  = ifelse(raw_choice == "safe", 1, 0),
    choose_decoy  = ifelse(raw_choice == "decoy", 1, 0)
  ) %>%
  group_by(condition, PROLIFIC_PID) %>%
  summarise(
    risky_rate = mean(choose_risky),
    safe_rate = mean(choose_safe),
    decoy_rate = mean(choose_decoy),
    .groups = "drop"
  )

# Ensure condition is a factor with reference = "risk_averse"
clustered_estimates1 <- clustered_estimates1 %>%
  mutate(condition = factor(condition, levels = c("risk_averse", "risk_seeking")))

# Fit linear models
mod_risky1 <- lm(risky_rate ~ condition, data = clustered_estimates1)
mod_safe1  <- lm(safe_rate  ~ condition, data = clustered_estimates1)
mod_decoy1  <- lm(decoy_rate  ~ condition, data = clustered_estimates1)

# Clustered SEs
risky_cl1 <- coef_test(mod_risky1, vcov = "CR2", cluster = clustered_estimates1$PROLIFIC_PID)
safe_cl1  <- coef_test(mod_safe1,  vcov = "CR2", cluster = clustered_estimates1$PROLIFIC_PID)
decoy_cl1  <- coef_test(mod_decoy1,  vcov = "CR2", cluster = clustered_estimate1s$PROLIFIC_PID)

# Inspect result tables
print(risky_cl1)
print(safe_cl1)
print(decoy_cl1)

# Helper function to safely extract coefficient and SE
get_coef_info <- function(tbl) {
  tbl %>%
    dplyr::filter(Coef != "(Intercept)") %>%
    dplyr::summarise(
      diff = beta,
      se   = SE
    ) %>%
    as.list()
}

# Extract risky and safe info
risky_info1 <- get_coef_info(risky_cl1)
safe_info1  <- get_coef_info(safe_cl1)
decoy_info1  <- get_coef_info(decoy_cl1)

# Combine into preference reversal table
pref_rev1 <- tibble(
  lottery = c("Risky lottery", "Safe lottery","Decoy"),
  diff = c(risky_info1$diff, safe_info1$diff, decoy_info1$diff),  # flip sign for safe
  se = c(risky_info1$se, safe_info1$se, decoy_info1$se)
) %>%
  mutate(
    ci_low = diff - 1.96 * se,
    ci_high = diff + 1.96 * se
  )

ggplot(pref_rev1, aes(x = lottery, y = diff)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray50") +
  geom_errorbar(aes(ymin = ci_low, ymax = ci_high),
                width = 0.15, linewidth = 0.6, color = "gray30") +
  geom_point(size = 4, color = "black") +
  geom_line(aes(group = 1), color = "gray50", linewidth = 0.8) +
  coord_cartesian(ylim = c(-0.15, 0.15), expand = 0) +
  labs(
    x = "",
    y = "Propotion of choosing when risky lottery is focal - when it is nonfocal",
    title = "Control Decoy ot Targeting Any Lottery",
    subtitle = "95% CI clustered by participant"
  ) +
  theme_minimal(base_size = 13) +
  theme(
    panel.grid.minor = element_blank(),
    plot.title = element_text(face = "bold")
  )
```
# Hetreo Effect (Pair)
```{r}
library(dplyr)
library(ggplot2)
library(clubSandwich)
library(broom)

# Step 1. Compute participant-level means per pair
clustered_estimates_pairs <- study1_complete %>%
  filter(treatment == "treatment") %>%
  mutate(
    choose_risky = ifelse(raw_choice == "risky", 1, 0),
    choose_safe  = ifelse(raw_choice == "safe", 1, 0)
  ) %>%
  group_by(condition, PROLIFIC_PID, pair) %>%  # pair_id = unique trial set
  summarise(
    risky_rate = mean(choose_risky),
    safe_rate  = mean(choose_safe),
    .groups = "drop"
  ) %>%
  mutate(condition = factor(condition, levels = c("risk_averse", "risk_seeking")))

# Step 2. Define helper to fit models with clustered SEs per pair
get_clustered_diff <- function(df, outcome) {
  mod <- lm(reformulate("condition", outcome), data = df)
  cl  <- coef_test(mod, vcov = "CR2", cluster = df$PROLIFIC_PID)
  cl_df <- as.data.frame(cl)
  est <- cl_df |> dplyr::filter(Coef == "conditionrisk_seeking")
  tibble(
    diff = est$beta,
    se = est$SE
  )
}

# Step 3. Loop through each pair to extract both risky & safe diffs
pair_results <- clustered_estimates_pairs %>%
  group_by(pair) %>%
  summarise(
    risky_diff = get_clustered_diff(cur_data(), "risky_rate")$diff,
    risky_se   = get_clustered_diff(cur_data(), "risky_rate")$se,
    safe_diff  = get_clustered_diff(cur_data(), "safe_rate")$diff,
    safe_se    = get_clustered_diff(cur_data(), "safe_rate")$se,
    .groups = "drop"
  )

# Step 4. Reshape and flip safe sign for consistency
pref_rev_pairs <- pair_results %>%
  mutate(safe_diff = -safe_diff) %>%
  tidyr::pivot_longer(
    cols = c(risky_diff, safe_diff, risky_se, safe_se),
    names_to = c("lottery", ".value"),
    names_pattern = "(risky|safe)_(diff|se)"
  ) %>%
  mutate(
    lottery = factor(lottery, levels = c("risky", "safe"),
                     labels = c("Risky lottery", "Safe lottery")),
    ci_low = diff - 1.96 * se,
    ci_high = diff + 1.96 * se
  )

p_hetero_pairs <- ggplot(pref_rev_pairs, 
       aes(x = factor(pair), y = diff, color = lottery, group = lottery)) +
  
  # Zero line
  geom_hline(yintercept = 0, linetype = "dotted", color = "gray60", linewidth = 0.8) +
  
  # Error bars
  geom_errorbar(aes(ymin = ci_low, ymax = ci_high),
                position = position_dodge(width = 0.45),
                width = 0.15, linewidth = 1.1) +
  
  # Points
  geom_point(position = position_dodge(width = 0.45), size = 4, show.legend = FALSE) +
  
  # Connecting lines
  geom_line(position = position_dodge(width = 0.45), linewidth = 0.9, show.legend = FALSE) +
  
  # Numeric labels above points
  geom_text(
    aes(label = sprintf("%.3f", diff), color = lottery),
    position = position_dodge(width = 0.45),
    vjust = -7.5, size = 4.5, fontface = "bold", show.legend = FALSE
  ) +
  
  # Color palette (consistent with other plots)
  scale_color_manual(values = c(
    "Risky lottery" = "#ff7f0e",  # orange
    "Safe lottery"  = "#1f77b4"   # blue
  )) +
  
  # Axis and coordinate control
  coord_cartesian(ylim = c(-0.18, 0.18), expand = FALSE, clip = "off") +
  scale_x_discrete(expand = expansion(mult = c(0.05, 0.05))) +
  
  # Labels
  labs(
    x = "Lottery pair",
    y = expression(Delta*" P(Chosen | Focal)"),
    title = "Heterogeneous Effects by Lottery Pair",
    subtitle = "95% CI clustered by participant",
    color = "Lottery Type"
  ) +
  
  # Theme styling
  theme_minimal(base_size = 18) +
  theme(
    legend.position = "top",
    legend.title = element_text(size = 16, face = "bold"),
    legend.text = element_text(size = 14),
    panel.grid.minor = element_blank(),
    panel.grid.major.x = element_blank(),
    axis.text.x = element_text(size = 13, face = "bold"),
    axis.text.y = element_text(size = 12),
    plot.title = element_text(face = "bold", size = 20, hjust = 0.5),
    plot.subtitle = element_text(size = 13, hjust = 0.5, color = "gray40"),
    axis.title.y = element_text(size = 15, margin = margin(r = 15)),
    plot.margin = margin(10, 20, 25, 10)
  )

p_hetero_pairs
```



# Attraction Effect: Treatment vs. Control
```{r, fig.width = 16, fig.height = 10}
library(dplyr)
library(ggplot2)
library(clubSandwich)
library(broom)

# Risk_Averse Condition

# Compute participant-level means
clustered_estimates <- study1_complete %>%
  filter(condition == "risk_averse") %>%
  mutate(
    choose_risky = ifelse(raw_choice == "risky", 1, 0),
    choose_safe  = ifelse(raw_choice == "safe", 1, 0),
    choose_decoy = ifelse(raw_choice == "decoy", 1, 0)
  ) %>%
  group_by(treatment, PROLIFIC_PID) %>%
  summarise(
    risky_rate = mean(choose_risky),
    safe_rate = mean(choose_safe),
    decoy_rate = mean(choose_decoy),
    .groups = "drop"
  )

# Ensure condition is a factor with reference = "risk_averse"
clustered_estimates <- clustered_estimates %>%
  mutate(treatment = factor(treatment, levels = c("control", "treatment")))

# Fit linear models
mod_risky <- lm(risky_rate ~ treatment, data = clustered_estimates)
mod_safe  <- lm(safe_rate  ~ treatment, data = clustered_estimates)
mod_decoy  <- lm(decoy_rate  ~ treatment, data = clustered_estimates)


# Clustered SEs
risky_cl <- coef_test(mod_risky, vcov = "CR2", cluster = clustered_estimates$PROLIFIC_PID)
safe_cl  <- coef_test(mod_safe,  vcov = "CR2", cluster = clustered_estimates$PROLIFIC_PID)
decoy_cl  <- coef_test(mod_decoy,  vcov = "CR2", cluster = clustered_estimates$PROLIFIC_PID)

# Inspect result tables
print(risky_cl)
print(safe_cl)
print(decoy_cl)

# Helper function to safely extract coefficient and SE
get_coef_info <- function(tbl) {
  tbl %>%
    dplyr::filter(Coef != "(Intercept)") %>%
    dplyr::summarise(
      diff = beta,
      se   = SE
    ) %>%
    as.list()
}

# Extract risky and safe info
risky_info <- get_coef_info(risky_cl)
safe_info  <- get_coef_info(safe_cl)
decoy_info  <- get_coef_info(decoy_cl)

# Combine into preference reversal table
pref_rev <- tibble(
  lottery = c("Risky lottery", "Safe lottery", "Decoy"),
  diff = c(risky_info$diff, safe_info$diff, decoy_info$diff),  # flip sign for safe
  se = c(risky_info$se, safe_info$se, decoy_info$se)
) %>%
  mutate(
    ci_low = diff - 1.96 * se,
    ci_high = diff + 1.96 * se
  )

p_risk_averse <- ggplot(pref_rev1, aes(x = lottery, y = diff)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray50") +
  geom_errorbar(aes(ymin = ci_low, ymax = ci_high),
                width = 0.1, linewidth = 0.9, color = "gray30") +
  geom_point(size = 4, color = "black") +
  geom_line(aes(group = 1), color = "gray50", linewidth = 0.8) +
  geom_text(aes(label = sprintf("%.3f", diff)), 
            vjust = -3, size = 5.5) +
  scale_x_discrete(expand = expansion(mult = c(0.001, 0.001))) + # tight edges
  coord_cartesian(ylim = c(-0.15, 0.15), expand = FALSE) +
  labs(
    x = "",
    y = "P(Chosen | Treatment Decoy) vs. P(Chosen | Control Decoy)",
    title = "Treatment Safe Decoy vs. Control Decoy",
    subtitle = "95% CI clustered by participant"
  ) +
  theme_minimal(base_size = 16) +
  theme(
    panel.grid.minor = element_blank(),
    panel.grid.major.x = element_blank(),
    plot.title = element_text(face = "bold"),
    axis.text.x = element_text(size = 13, margin = margin(t = 5))
  )

# Risk_Seeking Condition

# Compute participant-level means
clustered_estimates1 <- study1_complete %>%
  filter(condition == "risk_seeking") %>%
  mutate(
    choose_risky = ifelse(raw_choice == "risky", 1, 0),
    choose_safe  = ifelse(raw_choice == "safe", 1, 0),
    choose_decoy = ifelse(raw_choice == "decoy", 1, 0)
  ) %>%
  group_by(treatment, PROLIFIC_PID) %>%
  summarise(
    risky_rate = mean(choose_risky),
    safe_rate = mean(choose_safe),
    decoy_rate = mean(choose_decoy),
    .groups = "drop"
  )

# Ensure condition is a factor with reference = "risk_averse"
clustered_estimates1 <- clustered_estimates1 %>%
  mutate(treatment = factor(treatment, levels = c("control", "treatment")))

# Fit linear models
mod_risky1 <- lm(risky_rate ~ treatment, data = clustered_estimates1)
mod_safe1  <- lm(safe_rate  ~ treatment, data = clustered_estimates1)
mod_decoy1  <- lm(decoy_rate  ~ treatment, data = clustered_estimates1)


# Clustered SEs
risky_cl1 <- coef_test(mod_risky1, vcov = "CR2", cluster = clustered_estimates1$PROLIFIC_PID)
safe_cl1  <- coef_test(mod_safe1,  vcov = "CR2", cluster = clustered_estimates1$PROLIFIC_PID)
decoy_cl1  <- coef_test(mod_decoy1,  vcov = "CR2", cluster = clustered_estimates1$PROLIFIC_PID)

# Inspect result tables
print(risky_cl1)
print(safe_cl1)
print(decoy_cl1)

# Helper function to safely extract coefficient and SE
get_coef_info <- function(tbl) {
  tbl %>%
    dplyr::filter(Coef != "(Intercept)") %>%
    dplyr::summarise(
      diff = beta,
      se   = SE
    ) %>%
    as.list()
}

# Extract risky and safe info
risky_info1 <- get_coef_info(risky_cl1)
safe_info1  <- get_coef_info(safe_cl1)
decoy_info1  <- get_coef_info(decoy_cl1)

# Combine into preference reversal table
pref_rev1 <- tibble(
  lottery = c("Risky lottery", "Safe lottery", "Decoy"),
  diff = c(risky_info1$diff, safe_info1$diff, decoy_info1$diff),  # flip sign for safe
  se = c(risky_info1$se, safe_info1$se, decoy_info1$se)
) %>%
  mutate(
    ci_low = diff - 1.96 * se,
    ci_high = diff + 1.96 * se
  )

p_risk_seeking<-ggplot(pref_rev1, aes(x = lottery, y = diff)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray50") +
  geom_errorbar(aes(ymin = ci_low, ymax = ci_high),
                width = 0.1, linewidth = 0.9, color = "gray30") +
  geom_point(size = 4, color = "black") +
  geom_line(aes(group = 1), color = "gray50", linewidth = 0.8) +
  geom_text(aes(label = sprintf("%.3f", diff)), 
            vjust = -4, size = 5.5) +
  scale_x_discrete(expand = expansion(mult = c(0.001, 0.001))) + # tight edges
  coord_cartesian(ylim = c(-0.15, 0.15), expand = FALSE) +
  labs(
    x = "",
    y = "P(Chosen | Treatment Decoy) vs. P(Chosen | Control Decoy)",
    title = "Treatment Risky Decoy vs. Control Decoy",
    subtitle = "95% CI clustered by participant"
  ) +
  theme_minimal(base_size = 16) +
  theme(
    panel.grid.minor = element_blank(),
    panel.grid.major.x = element_blank(),
    plot.title = element_text(face = "bold"),
    axis.text.x = element_text(size = 13, margin = margin(t = 5))
  )


# Custom plotting function for consistency
plot_pref_rev <- function(pref_rev, title, color) {
  ggplot(pref_rev, aes(x = lottery, y = diff)) +
    geom_hline(yintercept = 0, linetype = "dotted", color = "gray60", linewidth = 0.8) +
    geom_errorbar(aes(ymin = ci_low, ymax = ci_high),
                  width = 0.15, linewidth = 1.1, color = color) +
    geom_point(size = 5, color = color) +
    geom_text(aes(label = sprintf("%.3f", diff)), 
              vjust = -4, size = 6, fontface = "bold", color = color) +
    scale_x_discrete(expand = expansion(mult = c(0.05, 0.05))) +
    coord_cartesian(ylim = c(-0.15, 0.15), expand = FALSE) +
    labs(
      x = "",
      y = expression(Delta*" P(Chosen | Treatment vs. Control)"),
      title = title,
      subtitle = "95% CI clustered by participant"
    ) +
    theme_minimal(base_size = 20) +
    theme(
  panel.grid.minor = element_blank(),
  panel.grid.major.x = element_blank(),
  axis.text.x = element_text(size = 16, face = "bold"),
  axis.text.y = element_text(size = 14),
  plot.title = element_text(face = "bold", size = 22, hjust = 0.5),
  plot.subtitle = element_text(size = 14, hjust = 0.5, color = "gray40"),
  axis.title.y = element_text(size = 16, margin = margin(r = 15)),
  plot.margin = margin(10, 10, 20, 10),          # slightly more top margin
  plot.title.position = "plot"
) +
coord_cartesian(ylim = c(-0.15, 0.15), expand = FALSE, clip = "off")   # <— key line!
}

# Make both plots
p_risk_averse <- plot_pref_rev(pref_rev, "Treatment Safe Decoy vs. Control", "#1f77b4")
p_risk_seeking <- plot_pref_rev(pref_rev1, "Treatment Risky Decoy vs. Control", "#ff7f0e")

# Combine side by side
p_risk_averse + p_risk_seeking +
  plot_annotation(
    title = "Effect of Decoy Treatments on Choice Probabilities",
    theme = theme(
      plot.title = element_text(size = 26, face = "bold", hjust = 0.5, margin = margin(b = 20))
    )
  )

```

`